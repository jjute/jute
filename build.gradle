/*
 * Configures this project AND each of its sub-projects.
 */
allprojects {
    // Every sub-project should belong to this group
    group = 'io.yooksi.jute'
}

/*
 * This variable will be initialized to true if the current
 * operating system platform is Windows and false otherwise
 */
ext.isOsWindows = System.getProperty("os.name").startsWith("Windows")

/**
 * Run a <i>platform-independent</i> shell command.
 */
def runShellCommand(String... arguments) {

    def stdout = new ByteArrayOutputStream()
    String[] command

    if (project.isOsWindows)
    {
        command = new String[arguments.length + 2]
        command[0] = 'cmd'; command[1] = '/c'
        System.arraycopy(arguments, 0, command, 2, arguments.length)
    }
    else command = arguments;

    exec {  commandLine command }
    println stdout.toString().trim()
}

/**
 * Execute a Git command with the given arguments.
 * The output will be printed to console
 */
def runGitCommand(String... args) {

    def stdout = new ByteArrayOutputStream()
    String[] cmdArgs = new String[args.length + 1]
    
    cmdArgs[0] = 'git'
    System.arraycopy(args, 0, cmdArgs, 1, args.length);
    
    exec { commandLine cmdArgs }
    println stdout.toString().trim()
}

/*
 * Clone all remote modules listed in 'juteModules' property to the local modules directory.
 * To clone only specific modules you can call this task with '-PjuteModules=<modules>' argument
 * which will define module names to process. Just remember to separate each module with a comma.
 */
tasks.register('cloneModules') {
    group = 'module'
    description = 'Clone remote modules from Github'

    List<String> registeredModules = Arrays.asList(juteModules.split(','))
    List<String> cloneTargets = new ArrayList<>()

    registeredModules.each { module ->
        if (!file("modules/$module").exists()) {
            cloneTargets << module as String
        }
    }
    if (cloneTargets.size() > 0) {
        logger.quiet("\nGoing to clone " + registeredModules.size() + " remote modules")
        cloneTargets.each { module ->
            String url = "https://github.com/jjute/$module"
            logger.quiet("Cloning from: $url")
            runGitCommand('clone', '--branch', 'develop', url, "modules/$module")
        }
    }
}
/*
 * List all Jute modules currently residing in the ./modules directory.
 */
tasks.register('listModules') {
    group = 'module'
    description = 'List all registered Jute modules.'
    doFirst {
        logger.quiet("List of registered Jute modules:")
    }
    doLast {
        rootProject.subprojects.each {
            logger.quiet("- $it.name")
        }
    }
}
